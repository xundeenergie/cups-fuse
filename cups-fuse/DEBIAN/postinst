#!/bin/sh



# postinst script for webpy-example
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

# source debconf library
. /usr/share/debconf/confmodule

l=$(grep "^UID_MIN" /etc/login.defs)
 
## get max UID limit ##
l1=$(grep "^UID_MAX" /etc/login.defs)
 
## use awk to print if UID >= $MIN and UID <= $MAX   ##
USERS=$(awk -F':' -v "min=${l##UID_MIN}" -v "max=${l1##UID_MAX}" '{ if ( $3 >= min && $3 <= max ) print $1}' /etc/passwd)
TARGET=$(gawk -F "=" '$1 ~ /WantedBy/ {print $2".wants"}' /etc/systemd/user/cups-fuse.service)
#TARGET=default.target.wants

case "$1" in

  configure)
    # restart systemd-user for all users to reread the printer-configuration
    echo "postinstall-script for fuse-cups"
    loginctl --no-legend -o cat|awk '{print $2,$3}'|sort|uniq|while read i u ; do
    	echo "restart user-systemd for $u $i"
	if /bin/systemctl is-active "user@${i}.service" >/dev/null ; then
		sudo -u $u /bin/systemctl restart --user cups-fuse.service
	fi
	sleep 0.5
    	#systemctl |grep "user@{$i}.service"  && echo systemctl restart "user@{$i}.service"
    done

    for u in $USERS; do
	    TDIR="$(awk -F ":" -v "u=$u" -v "T=$TARGET" '$1 == u {print $6"/.config/systemd/user/"T"/"}' /etc/passwd)"
	echo $TDIR
	[ -e ${TDIR} ] || su -c "mkdir -p ${TDIR}" $u
	su -c "ln -sf /etc/systemd/user/cups-fuse.service ${TDIR}" $u
    done

  ;;

  abort-upgrade|abort-remove|abort-deconfigure)
    exit 0
  ;;

  *)
    echo "postinst called with unknown argument \`$1'" >&2
    exit 1
  ;;

esac

#echo "Noch was"
# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

db_stop

exit 0
